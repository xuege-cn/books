
![](1.jpeg)

#### DOMContentLoaded
åˆå§‹HTMLæ–‡æ¡£è¢«å®Œå…¨åŠ è½½å’Œè§£æå®Œæˆä¹‹åï¼ŒDOMContentLoadedäº‹ä»¶è¢«è§¦å‘

##### ä»€ä¹ˆæ—¶å€™ç®—æ˜¯æ–‡æ¡£åŠ è½½å®Œï¼Ÿ
> åŒæ­¥javascriptä¼šæš‚åœDOMçš„è§£æ   

```
document.addEventListener('DOMContentLoaded', function () {
  console.log('DOMContentLoaded:', (Date.now() - domStart))
})
const start = Date.now()
while (true) {
  const end = Date.now()
  if (end - start > 5000) {
    break
  }
}
console.log('script loaded!')
```   
å¯ä»¥å‘ç°å½“æ—¶é—´æ˜¯5000æ—¶ï¼ŒDOMContentLoadedçš„æ—¶é—´ä¸º5048ï¼Œè€Œwhileçš„æ—¶é—´ä¸º1000æ—¶ï¼ŒDOMContentLoadedçš„æ—¶é—´ä¸º1048   
æ‰€ä»¥ï¼š**åŒæ­¥çš„JSæ–‡æ¡£é˜»å¡äº†DOMçš„è§£æ**   


##### async å’Œ deferå¯¹äºDOMContentLoadedçš„å½±å“
```
<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DOMContentLoaded:', (Date.now() - domStart))
  })
</script>
<script src="./test.js" async></script>

<!-- test.js -->
const start = Date.now()
while (true) {
  const end = Date.now()
  if (end - start > 5000) {
    break
  }
}
console.log('script loaded!')
```   

å‡ºç°äº†ä¸¤ç§ä¸åŒæƒ…å†µï¼š
- async
  - **asyncæ˜¯å¼‚æ­¥åŠ è½½ï¼ŒåŠ è½½å®Œæˆä¾¿æ‰§è¡Œ**
    - document.addEventListener('DOMContentLoaded', ...)åœ¨å‰é¢ï¼ŒDOMContentLoaded é©¬ä¸Šæ‰§è¡Œ
    - <script src="test.js"></script>åœ¨å‰é¢ï¼Œå°±çœ‹jsçš„ä¸‹è½½é€Ÿåº¦äº†ï¼Œåœ¨æ‰§è¡ŒDOMContentLoadedä¹‹å‰ä¸‹è½½å®Œæˆï¼ŒDOMContentLoadedçš„æ—¶é—´å°±æ˜¯5048
- **defer**
  - **è¯¥å±æ€§ç”¨æ¥é€šçŸ¥æµè§ˆå™¨è¯¥è„šæœ¬å°†åœ¨æ–‡æ¡£å®Œæˆè§£æåï¼Œè§¦å‘DOMContentLoadedäº‹ä»¶å‰æ‰§è¡Œ**
  - æ‰€ä»¥è¿™é‡ŒDOMContentLoadedæ—¶é—´æ˜¯5048

#### readyState
readyStateæ˜¯ä¸€ä¸ªåªè¯»å±æ€§   
readyStateçš„ä¸‰ç§çŠ¶æ€ï¼š
1. loading
2. interactive
3. complete   

readyStateæ”¹å˜çš„äº‹ä»¶ï¼šdocument.onreadystatechange

##### readyStateè·ŸDOMContentLoadedçš„å…³è”
DOMContentLoadedäº‹ä»¶å¿…é¡»æ˜¯åœ¨document.readyStateä¸ºloadingæ—¶ç»‘å®šæ‰æœ‰æ•ˆ   
```
const script = document.createElement('script')
script.src="./test.js"
document.body.appendChild(script)

<!-- ./test.js -->
console.log('test.js load')
document.addEventListener('DOMContentLoaded', function () {
  console.log('DOMContentLoaded')
})
```   

è¿™ä¸ªğŸŒ° å¯ä»¥çœ‹åˆ°ï¼šDOMContentLoadedäº‹ä»¶æœªè¢«æ‰§è¡Œ   

readyStateå’ŒDOMContentLoadedæ‰§è¡Œé¡ºåºï¼š
```
readyState: loading
        â†“
readyState: interctive
        â†“
DOMContentLoadedäº‹ä»¶
        â†“
readyState: complete
        â†“
      loadäº‹ä»¶
```

##### jsä»£ç æ”¾åœ¨æ–‡æ¡£æœ€å
æ­¤æ—¶jsæ˜¯ä¸éœ€è¦åƒä¸‹é¢è¿™æ ·å†™çš„
```
$(document).ready(function() {
  // å°‘å¹´çš„ä½ ï¼Œä»£ç å†™åœ¨è¿™é‡Œ...
});
```   

å…¶å®jsåœ¨æ–‡æ¡£æœ€åï¼Œæ–‡æ¡£å·²ç»è§£æå¥½äº†ï¼Œæ‰€ä»¥åªéœ€è¦åƒä¸‹é¢è¿™æ ·å†™å°±è¡Œäº†ï¼š
```
(function() {
  // è¿™é‡Œä»£ç ...
})();
```   

ä¼˜ç‚¹æ˜¯ï¼šæ‰§è¡Œæ—¶æœºæ›´å¿«

#### readyStateç°åœ¨è¿˜æœ‰å•¥é”¤å­ç”¨ï¼Ÿ
åˆ¤æ–­æ—¶æœºä¸ºloadingï¼Œç»‘å®šDOMContentLoadedäº‹ä»¶
```
if (document.readyState != 'loading') {
  init();
} else {
  window.addEventListener("DOMContentLoaded", function () {
    init();
  });
}
```