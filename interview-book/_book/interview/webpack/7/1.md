
![](1.jpeg)

### style-loader çš„ä½œç”¨
1. æŠŠ css æ’å…¥ html
2. å¼€å‘é˜¶æ®µæ¨¡å—çƒ­æ›´æ–°

### style-loader å’Œ css-loader çš„å…³ç³»
style-loader å’Œ css-loader ç»å¸¸ä¸€èµ·ä½¿ç”¨ï¼Œé‚£ä¹ˆä¸ä½¿ç”¨ css-loaderï¼Œåªç”¨ style-loader åŠ è½½ css è¡Œä¸è¡Œå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œçš„ ğŸ™…â€â™‚ï¸ 
1. style-loader åªæ˜¯æŠŠ css æ’å…¥ htmlï¼Œä½†æ˜¯å¹¶ä¸ä¼šè§£æ css æ–‡ä»¶
2. é‚£ä¹ˆ webpack æ˜¯ä¸è®¤è¯† css æ–‡ä»¶çš„ï¼Œéœ€è¦ css-loader æ¥åŠ è½½ cssæ–‡ä»¶
3. css-loader æ¢æˆ less-loader ä¹Ÿæ˜¯æˆç«‹çš„ï¼Œå…¶ä½œç”¨å°±æ˜¯åŠ è½½ css æ–‡ä»¶   

### è¯•æƒ³ä¸€ä¸‹ å®ç° style-loaderéœ€è¦è§£å†³ä»€ä¹ˆé—®é¢˜
1. å¦‚ä½•æ‹¿åˆ° css-loader è§£æä¹‹åçš„æºç ï¼Ÿ
2. å¦‚ä½•é¿å… css-loader çš„é‡å¤æ‰§è¡Œã€æ­»å¾ªç¯ã€‘ï¼Ÿ
3. å¦‚ä½•æ”¯æŒçƒ­æ›´æ–°ï¼Ÿ

**å¯ä»¥å®è¡Œçš„ä¸€ç§æ–¹æ¡ˆï¼š**   
1. æ¯æ¬¡çƒ­æ›´æ–°ï¼Œæ¯”å¦‚æ›´æ–°äº† index.cssï¼Œç½‘é¡µç«¯ä¼šæ”¶åˆ°ä¸€ä¸ªè¡¥ä¸åŒ…ï¼š./node_modules/css-loader/dist/cjs.js!./index.cssï¼Œç½‘é¡µç«¯æ”¶åˆ°è¡¥ä¸åŒ…ï¼Œä¼šå»æ›´æ–°è¿™ä¸ªæ¨¡å—
2. å®¢æˆ·ç«¯ç›‘å¬ module.hot.accept('./node_modules/css-loader/dist/cjs.js!./index.css', function () {})
3. å›è°ƒå‡½æ•°ä¸­ï¼Œé‡æ–°è·å–è¿™ä¸ªæ¨¡å—ç„¶åè¿›è¡Œæ›´æ–°
5. æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•æ‰¾åˆ°æœ€åˆçš„é‚£ä¸ª style èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å°±éœ€è¦ç”¨ä¸€ä¸ªæ˜ å°„æ¥ä¿å­˜ styleInDomï¼Œæ˜ å°„çš„å€¼ä¸ºæ›´æ–°å‡½æ•°ï¼Œé”®æ˜¯å•¥ï¼Ÿ
6. åŠ è½½ index.css æ’å…¥åˆ° htmlï¼Œé‚£ä¹ˆ index.css è¿™ä¸ªåç§°å°±å¯ä»¥ä½œä¸º key

### ä» style-loader çš„ä½¿ç”¨åˆ†æåŸç†
style-loader çš„åº”ç”¨åœºæ™¯ï¼š
```
loader: ['style-loader', 'css-loader']
```   

webpack loader çš„æ‰§è¡Œè·¯å¾„ï¼š
```
| - style-loader  `pitch`
	| - css-loader  `pitch`
		| - requested module is picked up as a dependency
	| - css-loader  normal execution
| - style-loader  normal execution
```   

#### css-loader è¿”å›ç»“æœåˆ†æ
css-loader åŠ è½½ css ä¹‹åï¼Œloader çš„ source å¦‚ä¸‹ï¼š
```
// Imports
var ___CSS_LOADER_API_IMPORT___ = require("../node_modules/css-loader/dist/runtime/api.js");
var ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(function(i){return i[1]});

// Module
___CSS_LOADER_EXPORT___.push([module.id, "nbody {n    background: yellow;n}n", ""]);

// Exports
module.exports = ___CSS_LOADER_EXPORT___;
```   

**ä»è¿™ä¸ªç»“æœæ¥çœ‹ï¼Œåœ¨ style-loader ä¸­éœ€è¦å¯¹ source è¿›è¡Œ require æ¨¡å—å¯¼å…¥ï¼Œç„¶åæ‰èƒ½æ‹¿åˆ°å…¶ä¸­çš„ css**   
1. åœ¨ loader ä¸­ require å¯¼å…¥å…¶ä»–æ¨¡å—ä¸è§„èŒƒ
2. è¿‡ç¨‹å¾ˆå¤æ‚

æ‰€ä»¥é‡‡ç”¨ pitch çš„æ–¹å¼

### pitch
pitch å¯ä»¥æ‹¦æˆª loaderï¼Œpitch ä¸­ return ä¼šå¯¼è‡´åç»­çš„ loader ä¸æ‰§è¡Œ

#### pitch çš„å†™æ³•
```
module.exports.pitch = function (remainingRequest, precedingRequest, data) {
    remainingRequestï¼š å‰©ä¸‹çš„è¯·æ±‚
    precedingRequestï¼šå·²å¤„ç†çš„è¯·æ±‚
    dataï¼šæ•°æ®
}
```   

style-loader é¦–å…ˆéœ€è¦æ‹¿åˆ° css-loader çš„å¤„ç†ç»“æœï¼š
```
module.exports = function (remainingRequest) {
    const remainingPath = loaderUtils.stringifyRequest(this, `!!${remainingRequest}`)
    return `
        import content from ${remainingPath}
    `
}
```   
è¿™æ ·å°±æ‹¿åˆ° css-loader å¤„ç†ä¹‹åçš„æ•°æ®äº†ã€‚å¦‚ä¸‹ï¼š
```
[
    0: [
        0: "./node_modules/css-loader/dist/cjs.js!./index.css"
        1: "body { color: red}",
        2: ""
    ],
    i: (modules, mediaQuery, dedupe) => {},
    length: 1
]
```   

ä»è¿™ä¸ªæ•°æ®ä¸­ï¼Œå¯ä»¥çœ‹å‡ºï¼š0 å¯ä»¥ä½œä¸º idï¼Œ1 å¯ä»¥ä½œä¸ºcss

#### æ¨¡å—çƒ­æ›´æ–°çš„å†™æ³•
```
webpack.config.js ä¸­é…ç½® devServer
devServer: {
    hot: true
}

æ¯ä¸ªéœ€è¦æ”¯æŒçƒ­æ›´æ–°çš„æ¨¡å—å£°æ˜ module.hot.accept
if (module.hot) {
    module.hot.accept('./index.css', function () {
        console.log('halo! css changed')
    })
}
```   
å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„ä»£ç ä¸­æ˜¯æ²¡æœ‰å£°æ˜ module.hot.accept çš„ï¼Œå¯æ˜¯ css å´æ”¯æŒçƒ­æ›´æ–°ï¼Œè¯´æ˜ loader ä¸­æ³¨å…¥äº†accept

#### accept æ³¨å…¥
accept ä¸­é‡æ–°è·å–css
```
if (module.hot) {
    module.hot.accept(remainingPath, function () {
        try {
            const newContent = require(remainingPath);
            // æ‹¿åˆ°æ–°çš„å†…å®¹ï¼Œé‡æ–°èµ°æ¸²æŸ“
            injectStyle(newContent);
        } catch (e) {
            console.log('çƒ­æ›´æ–°å‘ç”Ÿé”™è¯¯ï¼š', e)
        }
    })
}
```    
**è¿™é‡Œç”¨try catchåŒ…èµ·æ¥ï¼Œå› ä¸ºå¦‚æœè¿™ä¸ªå›è°ƒé‡ŒæŠ¥é”™ï¼Œwebpackä¼šèµ° reload å¯¼è‡´é¡µé¢åˆ·æ–°**

#### åˆ©ç”¨é—­åŒ…
å“ªäº›å˜é‡ç”¨åˆ°äº†é—­åŒ…å‘¢ï¼šstyleInDomï¼Œupdaterï¼Œstyle
```
function injectStyle (content) {
    for (let item of content) {
        const id = item[0];
        const updater = styleInDom[id];
        const css = item[1];
        // å¦‚æœå·²ç»æ¸²æŸ“è¿‡ï¼Œæ‹¿åˆ° updater æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­åˆ©ç”¨é—­åŒ…ç¼“å­˜äº† style èŠ‚ç‚¹ï¼Œæ›¿æ¢ style ä¸­å†…å®¹å³å¯
        if (updater) {
            updater(css);
        } else {
            styleInDom[id] = addStyle(css)
        }
    }
}

function addStyle (css) {
    const style = ducument.createElement('style');
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);

    return function updater (css) {
        if (css) {
            while (style.firstChild) {
                style.removeChild(style.firstChild);
            }
            style.appendChild(document.createTextNode(css));
        } else {
            style.parentNode.removeChild(style);
            delete styleInDom[id]
        }
    }
}
```   
è¿™é‡Œä¸ç®¡ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œè¿˜æ˜¯ä¹‹åçš„çƒ­æ›´æ–°ï¼Œæ¯æ¬¡ injectStyle å°±è¡Œäº†ï¼Œä¼ å…¥ css-loader è½¬æ¢ä¹‹åçš„ç»“æœ

### æ€»ç»“

![](2.png)